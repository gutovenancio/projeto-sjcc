<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil ‚Äì SJCC</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Oswald:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />
</head>
<body>

<main class="container">
  <header class="app-header" aria-label="Barra superior">
    <div class="app-header__left"></div>

    <img src="assets/brand/S√≠mbolo Jc.png" alt="JC" class="app-logo" />

    <div class="app-actions">
      <img src="Foto de Perfil.png" alt="Avatar" class="app-avatar" />
      <button class="icon-btn" aria-label="Pesquisar">
        <img src="assets/icons/lupa.png" alt="">
      </button>
      <button class="icon-btn" aria-label="Menu">
        <img src="assets/icons/menu.png" alt="">
      </button>
    </div>
  </header>

  <section class="top-row">
    <div class="top-left">
      <div class="top-grid">
        <div class="mini-stat">
          <img src="assets/icons/news.png" class="mini-icon-img" alt="">
          <div class="mini-value" id="metricNews">0</div>
          <div class="mini-label">not√≠cias lidas</div>
        </div>
        <div class="mini-stat">
          <img src="assets/icons/streak.png" class="mini-icon-img" alt="">
          <div class="mini-value" id="metricStreak">0</div>
          <div class="mini-label">dias de streak</div>
        </div>
        <div class="mini-stat">
          <img src="assets/icons/indica√ßoes.png" class="mini-icon-img" alt="">
          <div class="mini-value" id="metricReferrals">0</div>
          <div class="mini-label">indica√ß√µes</div>
        </div>
      </div>

      <section class="level-card perfil-ativo-only" id="levelCard">
        <div class="level-header">
          <span id="levelLabel">N√≠vel 1</span>
          <!-- direita: pontos atuais / pontos para o pr√≥ximo n√≠vel -->
          <strong class="points-strong" id="pointsRight">0 / 0 pontos</strong>
        </div>

        <div class="level-progress">
          <div class="level-bar-bg">
            <div class="level-bar-fill" id="levelBar"></div>
          </div>
          <div class="level-legend">
            <!-- legenda pedida no Figma fica √† ESQUERDA -->
            <span class="level-hint-left" id="nextLevelHint">Chegue em 0 pontos para conseguir o pr√≥ximo n√≠vel</span>
          </div>
        </div>
      </section>

      <section class="perfil-inativo" id="perfilInativoCard" style="display:none;">
        <div class="intro-title">Comece sua jornada de leitura</div>
        <p class="intro-text">Ative sua participa√ß√£o para acumular pontos e desbloquear recompensas.</p>
        <div class="steps">
          <div class="step"><div class="step-num">1</div><div class="step-text">Clique em <b>Participar</b>.</div></div>
          <div class="step"><div class="step-num">2</div><div class="step-text">Leia not√≠cias diariamente.</div></div>
          <div class="step"><div class="step-num">3</div><div class="step-text">Mantenha sua <b>streak</b> ativa.</div></div>
          <div class="step"><div class="step-num">4</div><div class="step-text">Indique amigos e ganhe JCoins.</div></div>
          <div class="step"><div class="step-num">5</div><div class="step-text">Resgate recompensas.</div></div>
        </div>
        <div class="cta-center">
          <button class="btn-primary" type="button">Participar</button>
        </div>
      </section>
    </div>

    <aside class="user-panel perfil-ativo-only" id="userPanel">
      <img src="Foto de Perfil.png" alt="Avatar" class="user-avatar" />
      <div class="user-info">
        <strong class="user-name" id="userName">Lucas Oliveira</strong>
        <div class="user-email" id="userEmail">lucasoliveira@email.com</div>
        <div class="user-prefs" id="userPrefs">
          <span class="chip">Pol√≠tica</span><span class="chip">Economia</span><span class="chip">Ci√™ncia</span>
        </div>
        <div class="user-wallet">Total na carteira: <b id="walletCoins">0 jcoins</b></div>
      </div>
    </aside>
  </section>

  <section class="content-grid">
    <div class="panel">
      <div class="panel-header">Ofertas para voc√™</div>
      <ul class="rewards-list" id="rewardsList">
        <li class="reward" data-price-brl="30">
          <div class="reward-info">
            <img src="assets/Rewards/Smiles.png" class="reward-logo" alt="">
            <div>
              <h4>Milhas no Smiles</h4>
              <p>1000 milhas para voc√™ utilizar</p>
            </div>
          </div>
          <div class="reward-cta">
            <span class="price-line">
              <b class="jcoin-value">0</b> <span class="jcoin-label">JCoins</span>
            </span>
            <span class="badge status"></span>
            <button class="redeem-btn" type="button" disabled>Resgatar</button>
          </div>
        </li>

        <li class="reward" data-price-brl="25">
          <div class="reward-info">
            <img src="assets/Rewards/Caneca JC.png" class="reward-logo" alt="">
            <div>
              <h4>Caneca do JC</h4>
              <p>Personalizada com o seu nome</p>
            </div>
          </div>
          <div class="reward-cta">
            <span class="price-line">
              <b class="jcoin-value">0</b> <span class="jcoin-label">JCoins</span>
            </span>
            <span class="badge status"></span>
            <button class="redeem-btn" type="button" disabled>Resgatar</button>
          </div>
        </li>

        <li class="reward" data-price-brl="15">
          <div class="reward-info">
            <img src="assets/Rewards/e-book jc.png" class="reward-logo" alt="">
            <div>
              <h4>E-book JC</h4>
              <p>Conte√∫do exclusivo sobre economia</p>
            </div>
          </div>
          <div class="reward-cta">
            <span class="price-line">
              <b class="jcoin-value">0</b> <span class="jcoin-label">JCoins</span>
            </span>
            <span class="badge status"></span>
            <button class="redeem-btn" type="button" disabled>Resgatar</button>
          </div>
        </li>

        <li class="reward" data-price-brl="200">
          <div class="reward-info">
            <img src="assets/Rewards/Netflix.png" class="reward-logo" alt="">
            <div>
              <h4>Voucher de R$ 200</h4>
              <p>Vale para parceiros selecionados</p>
            </div>
          </div>
          <div class="reward-cta">
            <span class="price-line">
              <b class="jcoin-value">0</b> <span class="jcoin-label">JCoins</span>
            </span>
            <span class="badge status"></span>
            <button class="redeem-btn" type="button" disabled>Resgatar</button>
          </div>
        </li>
      </ul>

      <p class="more-link">
        <a href="#">Ver outras recompensas</a>
      </p>
    </div>

    <div class="panel" id="rankingPanel">
      <div class="panel-header">Top Ranking</div>

      <div class="ranking-empty" id="rankingEmpty" style="display:none;">
        <p>Entre para ver o ranking completo e competir por posi√ß√µes.</p>
        <button class="btn-primary" type="button">Entrar</button>
      </div>

      <ol class="ranking-list" id="rankingList">
        <li>
          <img class="rank-medal" src="assets/icons/medal-1.png" alt="">
          <img class="rank-photo" src="Foto de Perfil.png" alt="">
          <span>Ana Carolina Santos</span>
          <b>100 üî•</b>
        </li>
        <li>
          <img class="rank-medal" src="assets/icons/medal-2.png" alt="">
          <img class="rank-photo" src="Foto de Perfil.png" alt="">
          <span>Ricardo Mendes</span>
          <b>89 üî•</b>
        </li>
        <li>
          <img class="rank-medal" src="assets/icons/medal-3.png" alt="">
          <img class="rank-photo" src="Foto de Perfil.png" alt="">
          <span>Maria Julia Costa</span>
          <b>63 üî•</b>
        </li>
        <li class="me">
          <img class="rank-photo" src="Foto de Perfil.png" alt="">
          <span>Lucas Oliveira</span>
          <b>50 üî•</b>
        </li>
        <li>
          <img class="rank-photo" src="Foto de Perfil.png" alt="">
          <span>Leila Soares</span>
          <b>49 üî•</b>
        </li>
      </ol>
    </div>
  </section>

  <footer class="history-footer">
    <button class="history-pill" type="button">VER HIST√ìRICO</button>
  </footer>
</main>

<script>
  // --- IN√çCIO DO C√ìDIGO DE INTEGRA√á√ÉO DA API ---

// --- 1. CONFIGURA√á√ÉO ---
    const USER_ID = 1; // Em um sistema real, este ID viria do sistema de login.
    const PROFILE_API_URL = 'http://localhost:4000'; // Nosso endpoint agregador!
    const POINTS_PER_BRL = 20; 

    // --- 2. FUN√á√ïES DE L√ìGICA DE C√ÅLCULO (Reutilizadas) ---
    function pointsForLevel(level) {
        if (level <= 1) return 0;
        return 50 * Math.pow(2, level - 2);
    }
    function calculateLevel(totalPoints) {
        let level = 1;
        while (totalPoints >= pointsForLevel(level + 1)) level++;
        return level;
    }
    
    // --- 3. FUN√á√ïES DE RENDERIZA√á√ÉO (Para preencher a tela) ---

    // Esta fun√ß√£o preenche os 3 cart√µes do topo
    function renderMetrics(data) {
    // CORRIGIDO:
    // 1. Os IDs corretos s√£o 'metricNews' e 'metricStreak'.
    // 2. A vari√°vel 'data' nesta fun√ß√£o J√Å √â o objeto 'metrics',
    //    ent√£o acessamos 'data.newsRead' diretamente (e n√£o 'data.metrics.newsRead').
    
    document.getElementById('metricNews').textContent = data.newsRead;
    document.getElementById('metricStreak').textContent = data.streakDays;
    document.getElementById('metricReferrals').textContent = data.referrals;
}

    // Esta fun√ß√£o preenche o painel de usu√°rio
    function renderUserPanel(user, wallet) {
        document.getElementById('userName').textContent = user.name;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('walletCoins').textContent = `${wallet.toLocaleString('pt-BR')} jcoins`;
        
        const prefsContainer = document.getElementById('userPrefs');
        prefsContainer.innerHTML = ''; 
        user.prefs.forEach(pref => {
            const span = document.createElement('span');
            span.className = 'chip'; 
            span.textContent = pref;
            prefsContainer.appendChild(span);
        });
    }

    // Esta fun√ß√£o preenche o card de N√≠vel e Pontos
    function renderLevelCard(userPoints) {
        const userLevel = calculateLevel(userPoints);
        const prevReq = pointsForLevel(userLevel);
        const nextReq = pointsForLevel(userLevel + 1);
        const currInLv = userPoints - prevReq;
        const gapLv = Math.max(1, nextReq - prevReq);
        const pct = Math.max(0, Math.min(100, Math.round((currInLv / gapLv) * 100)));

        document.getElementById('pointsRight').textContent = `${userPoints.toLocaleString('pt-BR')} / ${nextReq.toLocaleString('pt-BR')} pontos`;
        document.getElementById('levelLabel').textContent = `N√≠vel ${userLevel}`;
        document.getElementById('levelBar').style.width = pct + '%';
        document.getElementById('nextLevelHint').textContent = `Chegue em ${nextReq.toLocaleString('pt-BR')} pontos para conseguir o pr√≥ximo n√≠vel`;
    }

    // Esta fun√ß√£o preenche a lista de recompensas
    function renderRewards(rewards, userPoints) {
        document.querySelectorAll('#rewardsList .reward').forEach(item => {
            const priceBRL = Number(item.getAttribute('data-price-brl') || 0);
            const costPts  = Math.round(priceBRL * POINTS_PER_BRL);
            const numberEl = item.querySelector('.jcoin-value');
            const statusEl = item.querySelector('.status');
            const btn      = item.querySelector('.redeem-btn');

            if (numberEl) numberEl.textContent = costPts;

            if (userPoints >= costPts) {
                item.classList.add('can-redeem');
                statusEl.textContent = 'Dispon√≠vel';
                btn.disabled = false;
            } else {
                item.classList.add('locked');
                statusEl.textContent = `Faltam ${costPts - userPoints} JCoins`;
                btn.disabled = true;
            }
        });
    }

    // Esta fun√ß√£o preenche o ranking
    function renderRanking(rankingData, myUserId) {
        const rankingList = document.getElementById('rankingList');
        rankingList.innerHTML = ''; 
        
        const medalIcons = [
            'assets/icons/medal-1.png',
            'assets/icons/medal-2.png',
            'assets/icons/medal-3.png'
        ];

        rankingData.forEach((player, index) => {
            const li = document.createElement('li');
            if (player.id === myUserId) {
                li.className = 'me';
            }
            
            let posHtml = '';
            if (index < 3) {
                posHtml = `<img class="rank-medal" src="${medalIcons[index]}" alt="Medalha">`;
            } else {
                // Seu CSS original n√£o tinha um estilo para a posi√ß√£o
                // Vamos usar a tag <span class="pos"> que existe no HTML original (se houver)
                // Se n√£o, voc√™ pode adicionar este estilo: .pos-number { width: 26px; text-align: center; }
                posHtml = `<span class="pos-number" style="width:26px; text-align:center; font-weight: 700;">${index + 1}</span>`;
            }
            
            li.innerHTML = `${posHtml}
                            <img class="rank-photo" src="Foto de Perfil.png" alt="">
                            <span>${player.name}</span>
                            <b>${player.score} üî•</b>`;
            
            rankingList.appendChild(li);
        });
    }

    // --- 4. FUN√á√ÉO DE INTERA√á√ÉO (CLIQUE NO BOT√ÉO) ---
    async function incrementStreak() {
        const statusEl = document.getElementById('status-message');
        const streakEl = document.getElementById('streak-value');
        const readsEl = document.getElementById('read-articles-value');

        statusEl.textContent = 'Registrando leitura...';
        try {
            const response = await fetch(`${PROFILE_API_URL}/profile/increment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: USER_ID,
                    articleId: `artigo-lido-em-${new Date().toISOString()}`
                }),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);

            streakEl.textContent = result.current_streak;
            readsEl.textContent = result.totalReads;
            statusEl.textContent = result.status;
            
            // Se esta foi a primeira leitura, o usu√°rio agora est√° "ativo"
            // Ent√£o, trocamos o card de "inativo" pelo de "n√≠vel"
            if(result.totalReads > 0) {
                 toggleActiveProfile(true); 
            }

        } catch (error) {
            console.error('Erro ao registrar leitura:', error);
            statusEl.textContent = 'N√£o foi poss√≠vel conectar √† API.';
        }
    }
    
    // --- 5. FUN√á√ÉO DE CONTROLE DE EXIBI√á√ÉO ---
    function toggleActiveProfile(isLoggedIn, hasActivity) {
        // O painel do usu√°rio e o ranking s√≥ dependem de estar logado
        document.getElementById('userPanel').style.display = isLoggedIn ? '' : 'none';
        document.getElementById('rankingList').style.display  = isLoggedIn ? '' : 'none';
        document.getElementById('rankingEmpty').style.display = isLoggedIn ? 'none' : '';

        // Alterna entre o card de n√≠vel e o card de "Comece sua jornada"
        document.getElementById('levelCard').style.display = hasActivity ? '' : 'none';
        document.getElementById('perfilInativoCard').style.display = hasActivity ? 'none' : '';
    }

    // --- 6. FUN√á√ÉO PRINCIPAL DE CARREGAMENTO ---
    async function initializeProfile() {
        try {
            const response = await fetch(`${PROFILE_API_URL}/profile/${USER_ID}`);
            if (!response.ok) throw new Error('Falha ao carregar dados do perfil.');
            
            const data = await response.json();
            
            // Preenche todas as se√ß√µes com os dados da API
            renderMetrics(data.metrics);
            renderUserPanel(data.user, data.leveling.userPoints);
            renderLevelCard(data.leveling.userPoints);
            renderRewards(data.rewards.available, data.leveling.userPoints);
            renderRanking(data.ranking, USER_ID);

            // Decide o que mostrar (Estado Ativo vs. Inativo)
            const isLoggedIn = true; // A chamada funcionou, ent√£o ele est√° logado
            const userHasActivity = data.metrics.streakDays > 0 || data.metrics.newsRead > 0;
            toggleActiveProfile(isLoggedIn, userHasActivity);

        } catch (error) {
            console.error('Erro ao inicializar o perfil:', error);
            // Em caso de erro, mostramos o perfil como "inativo"
            toggleActiveProfile(false, false);
        }
    }

    // --- PONTO DE ENTRADA ---
    document.addEventListener('DOMContentLoaded', initializeProfile);

    // Conecta a fun√ß√£o de clique ao bot√£o (se ele existir)
    const readArticleButton = document.getElementById('read-article-button');
    if (readArticleButton) {
        readArticleButton.addEventListener('click', incrementStreak);
    }

</script>
</body>
</html>