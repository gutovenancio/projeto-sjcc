<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil ‚Äì SJCC</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Oswald:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />
</head>
<body>

<main class="container">
  <header class="app-header" aria-label="Barra superior">
    <div class="app-header__left"></div>

    <img src="assets/brand/S√≠mbolo Jc.png" alt="JC" class="app-logo" />

    <div class="app-actions">
      <img src="Foto de Perfil.png" alt="Avatar" class="app-avatar" />
      <button class="icon-btn" aria-label="Pesquisar">
        <img src="assets/icons/lupa.png" alt="">
      </button>
      <button class="icon-btn" aria-label="Menu">
        <img src="assets/icons/menu.png" alt="">
      </button>
    </div>
  </header>

  <section class="top-row">
    <div class="top-left">
      <div class="top-grid">
        <div class="mini-stat">
          <img src="assets/icons/news.png" class="mini-icon-img" alt="">
          <div class="mini-value" id="metricNews">0</div>
          <div class="mini-label">not√≠cias lidas</div>
        </div>
        <div class="mini-stat">
          <img src="assets/icons/streak.png" class="mini-icon-img" alt="">
          <div class="mini-value" id="metricStreak">0</div>
          <div class="mini-label">dias de streak</div>
        </div>
        
        <div class="mini-stat">
          <img src="assets/icons/indica√ßoes.png" class="mini-icon-img" alt="">
          <div class="mini-value" id="metricReferrals">0</div>
          <div class="mini-label">indica√ß√µes</div>
        </div>
      </div>

      <section class="level-card perfil-ativo-only" id="levelCard">
        <div class="level-header">
          <span id="levelLabel">N√≠vel 1</span>
          <strong class="points-strong" id="pointsRight">0 / 0 pontos</strong>
        </div>

        <div class="level-progress">
          <div class="level-bar-bg">
            <div class="level-bar-fill" id="levelBar"></div>
          </div>
          <div class="level-legend">
            <span class="level-hint-left" id="nextLevelHint">Chegue em 0 pontos para conseguir o pr√≥ximo n√≠vel</span>
          </div>
        </div>
       
      </section>

      <section class="perfil-inativo" id="perfilInativoCard" style="display:none;">
        <div class="intro-title">Comece sua jornada de leitura</div>
        <p class="intro-text">Ative sua participa√ß√£o para acumular pontos e desbloquear recompensas.</p>
        <div class="steps">
          <div class="step"><div class="step-num">1</div><div class="step-text">Clique em <b>Participar</b>.</div></div>
          <div class="step"><div class="step-num">2</div><div class="step-text">Leia not√≠cias diariamente.</div></div>
          <div class="step"><div class="step-num">3</div><div class="step-text">Mantenha sua <b>streak</b> ativa.</div></div>
          <div class="step"><div class="step-num">4</div><div class="step-text">Indique amigos e ganhe JCoins.</div></div>
          <div class="step"><div class="step-num">5</div><div class="step-text">Resgate recompensas.</div></div>
        </div>
        <div class="cta-center">
          <button class="btn-primary" type="button">Participar</button>
        </div>
      </section>
    </div>

    <aside class="user-panel perfil-ativo-only" id="userPanel">
      <img src="Foto de Perfil.png" alt="Avatar" class="user-avatar" />
      <div class="user-info">
        <strong class="user-name" id="userName">Lucas Oliveira</strong>
        <div class="user-email" id="userEmail">lucasoliveira@email.com</div>
        <div class="user-prefs" id="userPrefs">
          <span class="chip">Pol√≠tica</span><span class="chip">Economia</span><span class="chip">Ci√™ncia</span>
        </div>
        <div class="user-wallet">Total na carteira: <b id="walletCoins">0 jcoins</b></div>
      </div>
    </aside>
  </section>

  <section class="content-grid">
    <div class="panel">
      <div class="panel-header">Ofertas para voc√™</div>
      <ul class="rewards-list" id="rewardsList">
        <li style="padding: 20px; text-align: center; color: #666;">Carregando ofertas...</li>
      </ul>

      <p class="more-link">
        <a href="#">Ver outras recompensas</a>
      </p>
    </div>

    <div class="panel" id="rankingPanel">
      <div class="panel-header">Top Ranking</div>

      <div class="ranking-empty" id="rankingEmpty" style="display:none;">
        <p>Entre para ver o ranking completo e competir por posi√ß√µes.</p>
        <button class="btn-primary" type="button">Entrar</button>
      </div>

      <ol class="ranking-list" id="rankingList">
         </ol>
    </div>
  </section>

  <footer class="history-footer">
    <button class="history-pill" type="button">VER HIST√ìRICO</button>
  </footer>
</main>

<script>
  // --- IN√çCIO DO C√ìDIGO DE INTEGRA√á√ÉO DA API ---

  // --- 1. CONFIGURA√á√ÉO ---
    const USER_ID = 1; // Em um sistema real, este ID viria do sistema de login.
    const PROFILE_API_URL = 'http://localhost:4000'; // Nosso endpoint agregador!
    const POINTS_PER_BRL = 20; 

    // ---  FUN√á√ïES DE L√ìGICA DE C√ÅLCULO (Reutilizadas) ---
    function pointsForLevel(level) {
        if (level <= 1) return 0;
        return 50 * Math.pow(2, level - 2);
    }
    function calculateLevel(totalPoints) {
        let level = 1;
        while (totalPoints >= pointsForLevel(level + 1)) level++;
        return level;
    }
    
    // ---  FUN√á√ïES DE RENDERIZA√á√ÉO (Para preencher a tela) ---

    // Esta fun√ß√£o preenche os 3 cart√µes do topo
    function renderMetrics(data) {
        document.getElementById('metricNews').textContent = data.newsRead;
        document.getElementById('metricStreak').textContent = data.streakDays;
        document.getElementById('metricReferrals').textContent = data.referrals;
    }

    // Esta fun√ß√£o preenche o painel de usu√°rio
    function renderUserPanel(user, wallet) {
        document.getElementById('userName').textContent = user.name;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('walletCoins').textContent = `${wallet.toLocaleString('pt-BR')} jcoins`;
        
        const prefsContainer = document.getElementById('userPrefs');
        prefsContainer.innerHTML = ''; 
        user.prefs.forEach(pref => {
            const span = document.createElement('span');
            span.className = 'chip'; 
            span.textContent = pref;
            prefsContainer.appendChild(span);
        });
    }

    // Esta fun√ß√£o preenche o card de N√≠vel e Pontos
    function renderLevelCard(userPoints) {
        const userLevel = calculateLevel(userPoints);
        const prevReq = pointsForLevel(userLevel);
        const nextReq = pointsForLevel(userLevel + 1);
        const currInLv = userPoints - prevReq;
        const gapLv = Math.max(1, nextReq - prevReq);
        const pct = Math.max(0, Math.min(100, Math.round((currInLv / gapLv) * 100)));

        document.getElementById('pointsRight').textContent = `${userPoints.toLocaleString('pt-BR')} / ${nextReq.toLocaleString('pt-BR')} pontos`;
        document.getElementById('levelLabel').textContent = `N√≠vel ${userLevel}`;
        document.getElementById('levelBar').style.width = pct + '%';
        document.getElementById('nextLevelHint').textContent = `Chegue em ${nextReq.toLocaleString('pt-BR')} pontos para conseguir o pr√≥ximo n√≠vel`;
    }

    // Esta fun√ß√£o preenche a lista de recompensas
    function renderRewards(rewards, userPoints) {
        
        window.cachedRewards = rewards; 
        
        const rewardsList = document.getElementById('rewardsList');
        rewardsList.innerHTML = ''; // Limpa a lista para desenhar os dados reais

        if (!rewards || rewards.length === 0) {
            rewardsList.innerHTML = '<li>Nenhuma recompensa dispon√≠vel no momento.</li>';
            return;
        }

        //  MAPA DE IMAGENS
        const imageMap = {
            'Camiseta SJCC': 'assets/Rewards/Camiseta_SJCC.png', // Aponta para a nova imagem
            'Caneca SJCC': 'assets/Rewards/Caneca JC.png',
            'Clube de Descontos (1 m√™s)': 'assets/Rewards/Netflix.png' 
        };
        // ----------------------------------

        rewards.forEach(reward => {
            // Ignora recompensas inativas ou sem custo
            if (!reward.is_active || !reward.cost_points) return;

            // --- 2. L√ìGICA PARA MUDAR O TEXTO NA TELA ---
            let displayTitle = reward.title;
            let displayDescription = reward.description;

            // Se o item for o "Clube de Descontos", mudamos o texto visualmente
            if (reward.title === 'Clube de Descontos (1 m√™s)') {
                displayTitle = 'Netflix';
                displayDescription = '1 m√™s de assinatura';
            }
            // --------------------------------------------

            const costPts = reward.cost_points;
            const canAfford = userPoints >= costPts;

            const li = document.createElement('li');
            li.className = 'reward';
            li.classList.toggle('can-redeem', canAfford);
            li.classList.toggle('locked', !canAfford);

            // Determina o status para exibir
            let statusText = '';
            if (canAfford) {
                statusText = (reward.stock !== null) ? `${reward.stock} em estoque` : 'Dispon√≠vel';
            } else {
                statusText = `Faltam ${costPts - userPoints} JCoins`;
            }

            // Usa o mapa para pegar a imagem correta com base no t√≠tulo original do banco
            const logoUrl = imageMap[reward.title] || 'assets/icons/indica√ßoes.png'; 

            // Note que usamos 'displayTitle' e 'displayDescription' no HTML abaixo
            li.innerHTML = `
              <div class="reward-info">
                <img src="${logoUrl}" class="reward-logo" alt="${displayTitle}" style="background-color: #fff; object-fit: contain; padding: 4px;">
                <div>
                  <h4>${displayTitle}</h4>
                  <p>${displayDescription}</p>
                </div>
              </div>
              <div class="reward-cta">
                <span class="price-line">
                  <b class="jcoin-value">${costPts}</b> <span class="jcoin-label">JCoins</span>
                </span>
                <span class="badge status">${statusText}</span>
                <button class="redeem-btn" type="button" ${!canAfford ? 'disabled' : ''}>Resgatar</button>
              </div>
            `;

            // Adiciona o listener de clique no bot√£o
            const btn = li.querySelector('.redeem-btn');
            if (canAfford) {
                // Passa o ID real e o custo real para a fun√ß√£o de resgate
                btn.onclick = () => redeemReward(reward.id, costPts);
            }

            rewardsList.appendChild(li);
        });
    }

    // --- FUN√á√ÉO DE INTERA√á√ÉO (RESGATAR RECOMPENSA - MANTIDA) ---
    async function redeemReward(rewardId, cost) {
        if (!confirm(`Resgatar este item por ${cost} JCoins?`)) {
            return; // Usu√°rio cancelou
        }
        
        // Mostra um feedback visual que est√° carregando
        const btn = event.target; // Pega o bot√£o que foi clicado
        btn.disabled = true;
        btn.textContent = 'Aguarde...';

        try {
            // Chama DIRETAMENTE a API de Pr√™mios (porta 3003)
            const response = await fetch(`http://localhost:3003/redeem`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: USER_ID.toString(), // A API de pr√™mios espera o ID como string
                    rewardId: rewardId,
                    quantity: 1
                }),
            });

            const result = await response.json();
            if (!response.ok) {
                // Se a API retornar um erro (ex: 'insufficient_points'), mostra ele
                throw new Error(result.error || 'Erro desconhecido');
            }

            alert('Recompensa resgatada com sucesso!');

            // --- ATUALIZA A TELA EM TEMPO REAL ---
            
            // 1. Atualiza o saldo (carteira)
            document.getElementById('walletCoins').textContent = `${result.balanceAfter.toLocaleString('pt-BR')} jcoins`;
            
            // 2. Atualiza o card de N√≠vel (barra de progresso)
            renderLevelCard(result.balanceAfter);
            
            // 3. Re-desenha a lista de recompensas com o novo saldo
            renderRewards(window.cachedRewards || [], result.balanceAfter);

        } catch (error) {
            console.error('Erro ao resgatar recompensa:', error);
            alert(`Erro ao resgatar: ${error.message}`);
            // Devolve o bot√£o ao estado normal se der erro
            btn.disabled = false;
            btn.textContent = 'Resgatar';
        }
    }

    // Esta fun√ß√£o preenche o ranking
    function renderRanking(rankingData, myUserId) {
        const rankingList = document.getElementById('rankingList');
        rankingList.innerHTML = ''; 
        
        const medalIcons = [
            'assets/icons/medal-1.png',
            'assets/icons/medal-2.png',
            'assets/icons/medal-3.png'
        ];

        rankingData.forEach((player, index) => {
            const li = document.createElement('li');
            if (player.id === myUserId) {
                li.className = 'me';
            }
            
            let posHtml = '';
            if (index < 3) {
                posHtml = `<img class="rank-medal" src="${medalIcons[index]}" alt="Medalha">`;
            } else {
                posHtml = `<span class="pos-number" style="width:26px; text-align:center; font-weight: 700;">${index + 1}</span>`;
            }
            
            li.innerHTML = `${posHtml}
                            <img class="rank-photo" src="Foto de Perfil.png" alt="">
                            <span>${player.name}</span>
                            <b>${player.score} üî•</b>`;
            
            rankingList.appendChild(li);
        });
    }
    
    // ---  FUN√á√ÉO DE CONTROLE DE EXIBI√á√ÉO ---
    function toggleActiveProfile(isLoggedIn, hasActivity) {
        // O painel do usu√°rio e o ranking s√≥ dependem de estar logado
        document.getElementById('userPanel').style.display = isLoggedIn ? '' : 'none';
        document.getElementById('rankingList').style.display  = isLoggedIn ? '' : 'none';
        document.getElementById('rankingEmpty').style.display = isLoggedIn ? 'none' : '';

        // Alterna entre o card de n√≠vel e o card de "Comece sua jornada"
        document.getElementById('levelCard').style.display = hasActivity ? '' : 'none';
        document.getElementById('perfilInativoCard').style.display = hasActivity ? 'none' : '';
    }

    // ---  FUN√á√ÉO PRINCIPAL DE CARREGAMENTO ---
    async function initializeProfile() {
        try {
            const response = await fetch(`${PROFILE_API_URL}/profile/${USER_ID}`);
            if (!response.ok) throw new Error('Falha ao carregar dados do perfil.');
            
            const data = await response.json();
            
            // Preenche todas as se√ß√µes com os dados da API
            renderMetrics(data.metrics);
            renderUserPanel(data.user, data.leveling.userPoints);
            renderLevelCard(data.leveling.userPoints);
            renderRewards(data.rewards.available, data.leveling.userPoints);
            renderRanking(data.ranking, USER_ID);

            // Decide o que mostrar (Estado Ativo vs. Inativo)
            const isLoggedIn = true; // A chamada funcionou, ent√£o ele est√° logado
            const userHasActivity = data.metrics.streakDays > 0 || data.metrics.newsRead > 0;
            toggleActiveProfile(isLoggedIn, userHasActivity);

        } catch (error) {
            console.error('Erro ao inicializar o perfil:', error);
            // Em caso de erro, mostramos o perfil como "inativo"
            toggleActiveProfile(false, false);
        }
    }

    // --- PONTO DE ENTRADA ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Carrega todos os dados do perfil assim que a p√°gina abre
        initializeProfile();
    });

</script>
</body>
</html>